// This file will contain the complete database schema for the IT Asset Management System
// Run: npx prisma db push to apply changes

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// AUTHENTICATION & USER MANAGEMENT
// ============================================

model User {
  id           String     @id @default(uuid())
  email        String     @unique
  name         String
  password     String
  role         Role       @default(USER)
  status       UserStatus @default(ACTIVE)
  departmentId String?
  labId        String?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  // Relations
  department Department? @relation(fields: [departmentId], references: [id])
  lab        Lab?        @relation(fields: [labId], references: [id])
  accounts   Account[]
  sessions   Session[]

  // HOD Relations
  managedDepartment Department? @relation("HODRelation")

  // Lab Incharge Relations
  managedLab Lab? @relation("LabInchargeRelation")

  // Request Relations
  requestsCreated  Request[] @relation("RequestCreator")
  requestsApproved Request[] @relation("RequestApprover")

  // Ticket Relations
  ticketsCreated  Ticket[] @relation("TicketCreator")
  ticketsAssigned Ticket[] @relation("TicketAssignee")

  // Activity Logs
  activityLogs ActivityLog[]

  @@index([email])
  @@index([role])
  @@index([departmentId])
  @@index([labId])
}

enum Role {
  USER
  LAB_INCHARGE
  HOD
  ADMIN
  DEAN
}

enum UserStatus {
  ACTIVE
  PENDING
  REJECTED
}

model Account {
  id                String  @id @default(uuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(uuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ============================================
// ORGANIZATIONAL STRUCTURE
// ============================================

model Department {
  id          String   @id @default(uuid())
  name        String   @unique
  code        String   @unique
  description String?  @db.Text
  hodId       String?  @unique
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  hod      User?     @relation("HODRelation", fields: [hodId], references: [id])
  labs     Lab[]
  assets   Asset[]
  users    User[]
  requests Request[]
  tickets  Ticket[]
  activities ActivityLog[]

  @@index([hodId])
}

model Lab {
  id           String   @id @default(uuid())
  name         String
  code         String   @unique
  departmentId String
  inchargeId   String?  @unique
  capacity     Int      @default(0)
  location     String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  department Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  incharge   User?      @relation("LabInchargeRelation", fields: [inchargeId], references: [id])
  assets     Asset[]
  users      User[]
  tickets    Ticket[]
  activities ActivityLog[]

  @@index([departmentId])
  @@index([inchargeId])
}

// ============================================
// ASSET MANAGEMENT
// ============================================

model Asset {
  id             String         @id @default(uuid())
  assetNumber    String         @unique
  name           String
  type           AssetType
  category       String
  brand          String?
  model          String?
  serialNumber   String?        @unique
  macAddress     String?        @unique
  specifications String?        @db.Text
  purchaseDate   DateTime?
  purchasePrice  Float?
  warrantyExpiry DateTime?
  processor      String?
  ram            String?
  hdd            String?
  status         AssetStatus    @default(ACTIVE)
  condition      AssetCondition @default(GOOD)
  sheetOrder     Int?
  assignment     String?
  departmentId   String
  labId          String?
  location       String?
  notes          String?        @db.Text
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  // Relations
  department      Department       @relation(fields: [departmentId], references: [id])
  lab             Lab?             @relation(fields: [labId], references: [id])
  tickets         Ticket[]
  maintenanceLogs MaintenanceLog[]

  @@index([assetNumber])
  @@index([type])
  @@index([status])
  @@index([departmentId])
  @@index([labId])
}

enum AssetType {
  DESKTOP
  LAPTOP
  SERVER
  ROUTER
  SWITCH
  PRINTER
  SCANNER
  PROJECTOR
  UPS
  MONITOR
  KEYBOARD
  MOUSE
  OTHER
}

enum AssetStatus {
  ACTIVE
  UNDER_MAINTENANCE
  RETIRED
  DAMAGED
  LOST
}

enum AssetCondition {
  EXCELLENT
  GOOD
  FAIR
  POOR
  DAMAGED
}

// ============================================
// REQUEST MANAGEMENT (HOD → DEAN)
// ============================================

model Request {
  id              String        @id @default(uuid())
  requestNumber   String        @unique
  title           String
  description     String        @db.Text
  type            RequestType
  priority        Priority      @default(NORMAL)
  status          RequestStatus @default(PENDING)
  departmentId    String
  createdById     String
  approvedById    String?
  assignedAdminId String?
  remarks         String?       @db.Text
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  approvedAt      DateTime?
  completedAt     DateTime?

  // Relations
  department Department @relation(fields: [departmentId], references: [id])
  createdBy  User       @relation("RequestCreator", fields: [createdById], references: [id], onDelete: Cascade)
  approvedBy User?      @relation("RequestApprover", fields: [approvedById], references: [id])

  @@index([requestNumber])
  @@index([status])
  @@index([departmentId])
  @@index([createdById])
  @@index([approvedById])
}

enum RequestType {
  NEW_SYSTEM
  HARDWARE_REPAIR
  SOFTWARE_INSTALLATION
  NETWORK_UPGRADE
  LAB_SETUP
  ACCOUNT_APPROVAL
  OTHER
}

enum RequestStatus {
  PENDING
  APPROVED
  DECLINED
  ASSIGNED
  IN_PROGRESS
  COMPLETED
}

// ============================================
// TICKET MANAGEMENT (Lab Incharge → HOD → Admin)
// ============================================

model Ticket {
  id           String       @id @default(uuid())
  ticketNumber String       @unique
  title        String
  description  String       @db.Text
  issueType    IssueType
  priority     Priority     @default(NORMAL)
  status       TicketStatus @default(SUBMITTED)
  assetId      String?
  departmentId String
  labId        String?
  createdById  String
  assignedToId String?
  resolution   String?      @db.Text
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  resolvedAt   DateTime?

  // Relations
  asset      Asset?     @relation(fields: [assetId], references: [id])
  department Department @relation(fields: [departmentId], references: [id])
  lab        Lab?       @relation(fields: [labId], references: [id])
  createdBy  User       @relation("TicketCreator", fields: [createdById], references: [id], onDelete: Cascade)
  assignedTo User?      @relation("TicketAssignee", fields: [assignedToId], references: [id])

  @@index([ticketNumber])
  @@index([status])
  @@index([assetId])
  @@index([departmentId])
  @@index([labId])
  @@index([createdById])
  @@index([assignedToId])
}

enum IssueType {
  HARDWARE
  SOFTWARE
  NETWORK
  OTHER
}

enum TicketStatus {
  SUBMITTED
  APPROVED
  QUEUED
  PROCESSING
  DEPLOYED
  RESOLVED
  CLOSED
}

enum Priority {
  LOW
  NORMAL
  HIGH
  CRITICAL
}

// ============================================
// MAINTENANCE & ACTIVITY LOGS
// ============================================

model MaintenanceLog {
  id          String   @id @default(uuid())
  assetId     String
  description String   @db.Text
  performedBy String
  cost        Float?
  performedAt DateTime @default(now())
  createdAt   DateTime @default(now())

  // Relations
  asset Asset @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@index([assetId])
  @@index([performedAt])
}

model ActivityLog {
  id           String   @id @default(uuid())
  userId       String
  action       String
  entity       String
  entityId     String?
  details      String?  @db.Text
  ipAddress    String?
  userAgent    String?  @db.Text
  departmentId String?
  labId        String?
  createdAt    DateTime @default(now())

  // Relations
  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  department Department? @relation(fields: [departmentId], references: [id])
  lab        Lab?        @relation(fields: [labId], references: [id])

  @@index([userId])
  @@index([entity])
  @@index([departmentId])
  @@index([labId])
  @@index([createdAt])
}
